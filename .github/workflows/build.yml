name: AutoTask Android CI

on:
  workflow_dispatch:

jobs:  
  build:  
    runs-on: ubuntu-latest  
      
    steps:  
    - uses: actions/checkout@v4  
      
    - name: Set up JDK 18  
      uses: actions/setup-java@v4  
      with:  
        java-version: '18'  
        distribution: 'temurin'  
          
    - name: Cache Gradle packages  
      uses: actions/cache@v3  
      with:  
        path: |  
          ~/.gradle/caches  
          ~/.gradle/wrapper  
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}  
        restore-keys: |  
          ${{ runner.os }}-gradle-  
            
    - name: Cache NDK  
      uses: actions/cache@v3  
      with:  
        path: |  
          ~/.android/ndk  
        key: ${{ runner.os }}-ndk-${{ hashFiles('**/build.gradle*') }}  
          
    - name: Grant execute permission for gradlew  
      run: chmod +x gradlew  
        
    - name: Create local.properties  
      run: |  
        echo "storeFile=${{ github.workspace }}/keystore.jks" >> local.properties  
        echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> local.properties  
        echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> local.properties  
        echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> local.properties  
          
    - name: Decode keystore  
      env:  
        ENCODED_STRING: ${{ secrets.KEYSTORE_BASE64 }}  
      run: |  
        echo $ENCODED_STRING | base64 -di > keystore.jks  
          
    - name: Build debug APK  
      run: ./gradlew assembleDebug  
        
    - name: Build release APK  
      run: ./gradlew assembleRelease  
        
    - name: Upload debug APK  
      uses: actions/upload-artifact@v4  
      with:  
        name: debug-apk  
        path: app/build/outputs/apk/debug/*.apk  
          
    - name: Upload release APK  
      uses: actions/upload-artifact@v4  
      with:  
        name: release-apk  
        path: app/build/outputs/apk/release/*.apk  
          
    - name: Build debug AAB  
      run: ./gradlew bundleDebug  
        
    - name: Build release AAB  
      run: ./gradlew bundleRelease  
        
    - name: Upload debug AAB  
      uses: actions/upload-artifact@v4  
      with:  
        name: debug-aab  
        path: app/build/outputs/bundle/debug/*.aab  
          
    - name: Upload release AAB  
      uses: actions/upload-artifact@v4  
      with:  
        name: release-aab  
        path: app/build/outputs/bundle/release/*.aab
